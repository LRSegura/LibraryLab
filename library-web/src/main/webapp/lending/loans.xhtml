<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:p="http://primefaces.org/ui">

<ui:composition template="/WEB-INF/templates/layout.xhtml">
    <ui:define name="title">Loans - LibraryLab</ui:define>

    <ui:define name="breadcrumb">
        <i class="pi pi-arrow-right-arrow-left"></i> Lending / Loans
    </ui:define>

    <ui:define name="content">
        <div class="page-header">
            <h1>Loans Management</h1>
            <p>Manage book loans and returns</p>
        </div>

        <div class="card">
            <h:form id="loanForm">
                <p:toolbar>
                    <p:toolbarGroup>
                        <p:commandButton value="New Loan" icon="pi pi-plus"
                                         styleClass="ui-button-success mr-2"
                                         action="#{loanBean.initNewLoan}"
                                         oncomplete="PF('loanDialog').show()"
                                         update=":loanForm:loanDialogContent"/>
                        <p:commandButton value="Refresh" icon="pi pi-refresh"
                                         styleClass="ui-button-secondary"
                                         action="#{loanBean.loadLoans}"
                                         update="loanTable"/>
                    </p:toolbarGroup>
                    <p:toolbarGroup align="right">
                        <p:selectOneMenu value="#{loanBean.statusFilter}" styleClass="mr-2">
                            <f:selectItem itemLabel="All Statuses" itemValue=""/>
                            <f:selectItems value="#{loanBean.statuses}" var="st"
                                           itemLabel="#{st.description}" itemValue="#{st}"/>
                            <p:ajax event="change" listener="#{loanBean.filterByStatus}"
                                    update="loanTable"/>
                        </p:selectOneMenu>
                    </p:toolbarGroup>
                </p:toolbar>

                <p:dataTable id="loanTable" value="#{loanBean.loans}" var="loan"
                             filteredValue="#{loanBean.filteredLoans}"
                             paginator="true" rows="10"
                             paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="5,10,20,50"
                             emptyMessage="No loans found"
                             styleClass="mt-3"
                             rowStyleClass="#{loan.overdue ? 'bg-red-50' : ''}" paginatorPosition="bottom">

                    <p:column headerText="Book" sortBy="#{loan.bookTitle}" filterBy="#{loan.bookTitle}">
                        <div><h:outputText value="#{loan.bookTitle}" styleClass="font-bold"/></div>
                        <small class="text-500">#{loan.bookIsbn}</small>
                    </p:column>
                    <p:column headerText="Member" sortBy="#{loan.memberName}" filterBy="#{loan.memberName}">
                        <div><h:outputText value="#{loan.memberName}"/></div>
                        <small class="text-500">#{loan.membershipNumber}</small>
                    </p:column>
                    <p:column headerText="Loan Date" sortBy="#{loan.loanDate}">
                        <h:outputText value="#{loan.loanDate}"><f:convertDateTime type="localDate" pattern="MMM dd, yyyy"/></h:outputText>
                    </p:column>
                    <p:column headerText="Due Date" sortBy="#{loan.dueDate}">
                        <h:outputText value="#{loan.dueDate}" styleClass="#{loan.overdue ? 'text-red-500 font-bold' : ''}">
                            <f:convertDateTime type="localDate" pattern="MMM dd, yyyy"/>
                        </h:outputText>
                        <br/>
                        <small class="#{loan.overdue ? 'text-red-500' : 'text-green-500'}">
                            <h:outputText value="#{loan.daysOverdue} days overdue" rendered="#{loan.overdue}"/>
                            <h:outputText value="#{loan.daysUntilDue} days left" rendered="#{not loan.overdue and loan.status == 'ACTIVE'}"/>
                        </small>
                    </p:column>
                    <p:column headerText="Return Date" sortBy="#{loan.returnDate}">
                        <h:outputText value="#{loan.returnDate}" rendered="#{loan.returnDate != null}">
                            <f:convertDateTime type="localDate" pattern="MMM dd, yyyy"/>
                        </h:outputText>
                        <h:outputText value="-" rendered="#{loan.returnDate == null}"/>
                    </p:column>
                    <p:column headerText="Renewals" style="text-align: center;">
                        <p:badge value="#{loan.renewalCount}" severity="info"/>
                    </p:column>
                    <p:column headerText="Status" sortBy="#{loan.status}">
                        <p:tag value="#{loan.status.description}" severity="#{loanBean.getStatusSeverity(loan.status)}"/>
                    </p:column>

                    <p:column headerText="Actions" style="width: 180px; text-align: center;">
                        <p:commandButton icon="pi pi-check"
                                         styleClass="ui-button-rounded ui-button-success ui-button-flat mr-2"
                                         action="#{loanBean.returnBook(loan)}"
                                         update="loanTable :globalGrowl"
                                         rendered="#{loan.status == 'ACTIVE' or loan.status == 'OVERDUE'}"
                                         process="@this">
                            <p:tooltip value="Return Book"/>
                        </p:commandButton>

                        <p:commandButton icon="pi pi-replay"
                                         styleClass="ui-button-rounded ui-button-info ui-button-flat mr-2"
                                         action="#{loanBean.renewLoan(loan)}"
                                         update="loanTable :globalGrowl"
                                         rendered="#{loan.canRenew}"
                                         process="@this">
                            <p:tooltip value="Renew Loan"/>
                        </p:commandButton>

                        <p:commandButton icon="pi pi-exclamation-triangle"
                                         styleClass="ui-button-rounded ui-button-warning ui-button-flat"
                                         action="#{loanBean.markAsLost(loan)}"
                                         update="loanTable :globalGrowl"
                                         rendered="#{loan.status == 'ACTIVE' or loan.status == 'OVERDUE'}"
                                         process="@this">
                            <p:confirm header="Confirm" message="Mark this book as lost?" icon="pi pi-exclamation-triangle"/>
                            <p:tooltip value="Mark as Lost"/>
                        </p:commandButton>
                    </p:column>
                </p:dataTable>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes ui-button-warning"
                                     icon="pi pi-check"/>
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary"
                                     icon="pi pi-times"/>
                </p:confirmDialog>

                <p:dialog header="New Loan"
                          widgetVar="loanDialog" modal="true"
                          showEffect="fade" hideEffect="fade"
                          responsive="true" width="500">
                    <p:outputPanel id="loanDialogContent">
                        <h:panelGrid columns="2" cellpadding="10" styleClass="w-full">
                            <p:outputLabel for="book" value="Book:"/>
                            <p:selectOneMenu id="book" value="#{loanBean.currentLoan.bookId}"
                                             required="true" requiredMessage="Book is required"
                                             styleClass="w-full"
                                             filter="true" filterMatchMode="contains">
                                <f:selectItem itemLabel="-- Select a Book --" itemValue=""/>
                                <f:selectItems value="#{loanBean.availableBooks}" var="book"
                                               itemLabel="#{book.title} (#{book.isbn})" itemValue="#{book.id}"/>
                            </p:selectOneMenu>

                            <p:outputLabel for="member" value="Member:"/>
                            <p:selectOneMenu id="member" value="#{loanBean.currentLoan.memberId}"
                                             required="true" requiredMessage="Member is required"
                                             styleClass="w-full"
                                             filter="true" filterMatchMode="contains">
                                <f:selectItem itemLabel="-- Select a Member --" itemValue=""/>
                                <f:selectItems value="#{loanBean.activeMembers}" var="member"
                                               itemLabel="#{member.fullName} (#{member.membershipNumber})"
                                               itemValue="#{member.id}"/>
                            </p:selectOneMenu>

                            <p:outputLabel for="notes" value="Notes:"/>
                            <p:inputTextarea id="notes" value="#{loanBean.currentLoan.notes}"
                                             rows="3" styleClass="w-full"/>
                        </h:panelGrid>

                        <div class="flex justify-content-end mt-3">
                            <p:commandButton value="Cancel" icon="pi pi-times"
                                             styleClass="ui-button-secondary ui-button-outlined mr-2"
                                             onclick="PF('loanDialog').hide()" type="button"/>
                            <p:commandButton value="Create Loan" icon="pi pi-check"
                                             styleClass="ui-button-success"
                                             action="#{loanBean.borrowBook}"
                                             update="loanTable :globalGrowl :loanForm:loanDialogContent"
                                             oncomplete="if(!args.validationFailed) PF('loanDialog').hide()"/>
                        </div>
                    </p:outputPanel>
                </p:dialog>
            </h:form>
        </div>
    </ui:define>
</ui:composition>
</html>